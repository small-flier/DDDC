{"version":3,"file":"gps.js","sources":["uni_modules/json-gps/js_sdk/gps.js"],"sourcesContent":["// #ifdef APP-PLUS\r\nimport permision from \"./wa-permission/permission.js\"\r\n// #endif\r\nclass Gps {\r\n\tconstructor(arg) {\r\n\t\tthis.lock = false //锁防止重复请求\r\n\t}\r\n\tasync getLocation(param = {\r\n\t\ttype: 'wgs84'\r\n\t}) {\r\n\t\treturn new Promise(async (callback) => {\r\n\t\t\tif (this.lock) {\r\n\t\t\t\t// console.log('已锁，已有另一个请求正在执行。无需重复请求');\r\n\t\t\t\tcallback(false);\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\t\t\tthis.lock = true //加锁防止重复的请求\r\n\t\t\tuni.getLocation({\r\n\t\t\t\t...param,\r\n\t\t\t\tsuccess: res => {\r\n\t\t\t\t\tthis.lock = false //成功后解锁\r\n\t\t\t\t\t//console.log(res);\r\n\t\t\t\t\tcallback(res)\r\n\t\t\t\t},\r\n\t\t\t\tfail: async (err) => {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: '定位获取失败',\r\n\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconsole.error(JSON.stringify(err))\n\t\t\t\t\tcallback(false)\n\t\t\t\t\t\r\n\t\t\t\t\t// #ifdef APP-PLUS\r\n\t\t\t\t\tawait this.checkGpsIsOpen()\r\n\t\t\t\t\t// #endif\n\t\t\t\t\t\r\n\t\t\t\t\t// #ifdef MP-WEIXIN\r\n\t\t\t\t\tif (err.errMsg == 'getLocation:fail auth deny') {\r\n\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\tcontent: '应用无定位权限',\r\n\t\t\t\t\t\t\tconfirmText: '前往设置',\r\n\t\t\t\t\t\t\tcomplete: (e) => {\r\n\t\t\t\t\t\t\t\tif (e.confirm) {\r\n\t\t\t\t\t\t\t\t\tuni.openSetting({\r\n\t\t\t\t\t\t\t\t\t\tsuccess(res) {\r\n\t\t\t\t\t\t\t\t\t\t\tconsole.log(res.authSetting)\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.lock = false //解锁让回到界面重新获取\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\n\t\t\t\t\tif (err.errMsg == 'getLocation:fail:ERROR_NOCELL&WIFI_LOCATIONSWITCHOFF') {\n\t\t\t\t\t\tuni.showModal({\n\t\t\t\t\t\t\tcontent: '未开启定位权限，请前往手机系统设置中开启',\n\t\t\t\t\t\t\tshowCancel: false,\n\t\t\t\t\t\t\tconfirmText:\"知道了\"\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\t// #endif\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t})\r\n\t}\n\t// #ifdef APP-PLUS\n\tasync checkGpsIsOpen() {\n\t\tthis.lock = true //加锁防止重复的请求\n\t\t// console.log('检查定位设置开启问题', permision.checkSystemEnableLocation());\n\t\tif (!permision.checkSystemEnableLocation()) {\n\t\t\tplus.nativeUI.confirm(\"手机定位权限没有开启，是否去开启？\", (e) => {\n\t\t\t\tthis.lock = false\n\t\t\t\tif (e.index == 0) {\n\t\t\t\t\tif (uni.getSystemInfoSync().platform == \"ios\") {\n\t\t\t\t\t\tplus.runtime.openURL(\"app-settings://\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvar main = plus.android.runtimeMainActivity(); //获取activity\n\t\t\t\t\t\tvar Intent = plus.android.importClass('android.content.Intent');\n\t\t\t\t\t\tvar Settings = plus.android.importClass('android.provider.Settings');\n\t\t\t\t\t\tvar intent = new Intent(Settings\n\t\t\t\t\t\t.ACTION_LOCATION_SOURCE_SETTINGS); //可设置表中所有Action字段  \n\t\t\t\t\t\tmain.startActivity(intent);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '设备无定位权限',\n\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t});\n\t\t\t\t\tcallback(false)\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\t\"buttons\": [\"去设置\", \"不开启\"],\n\t\t\t\t\"verticalAlign\": \"center\"\n\t\t\t});\n\t\t\treturn false\n\t\t}\n\t\tlet checkAppGpsRes = await this.checkAppGps()\n\t\t// console.log(checkAppGpsRes, 'checkAppGpsRes');\n\t\tif (!checkAppGpsRes) {\n\t\t\tplus.nativeUI.confirm(\"应用定位权限没有开启，是否去开启？\", (e) => {\n\t\t\t\tthis.lock = false\n\t\t\t\tif (e.index == 0) {\n\t\t\t\t\tpermision.gotoAppPermissionSetting()\n\t\t\t\t\tcallback(false)\n\t\t\t\t} else {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: '应用无定位权限',\n\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t});\n\t\t\t\t\treturn false\n\t\t\t\t}\n\t\t\t}, {\n\t\t\t\t\"buttons\": [\"去设置\", \"不开启\"],\n\t\t\t\t\"verticalAlign\": \"center\"\n\t\t\t});\n\t\t} else {\n\t\t\tthis.lock = false\n\t\t}\n\t}\n\tasync checkAppGps() {\n\t\tif (uni.getSystemInfoSync().platform == \"ios\" && !permision.judgeIosPermission(\"location\")) {\n\t\t\treturn false\n\t\t}\n\t\tif (uni.getSystemInfoSync().platform != \"ios\" && await permision.requestAndroidPermission(\n\t\t\t\t\"android.permission.ACCESS_FINE_LOCATION\") != 1) {\n\t\t\treturn false\n\t\t}\n\t\treturn true\n\t}\n\t// #endif\r\n}\r\nexport default Gps\n"],"names":["uni"],"mappings":";;AAGA,MAAM,IAAI;AAAA,EACT,YAAY,KAAK;AAChB,SAAK,OAAO;AAAA,EACZ;AAAA,EACD,MAAM,YAAY,QAAQ;AAAA,IACzB,MAAM;AAAA,EACR,GAAI;AACF,WAAO,IAAI,QAAQ,OAAO,aAAa;AACtC,UAAI,KAAK,MAAM;AAEd,iBAAS,KAAK;AACd,eAAO;AAAA,MACP;AACD,WAAK,OAAO;AACZA,oBAAAA,MAAI,YAAY;AAAA,QACf,GAAG;AAAA,QACH,SAAS,SAAO;AACf,eAAK,OAAO;AAEZ,mBAAS,GAAG;AAAA,QACZ;AAAA,QACD,MAAM,OAAO,QAAQ;AACpBA,wBAAAA,MAAI,UAAU;AAAA,YACb,OAAO;AAAA,YACP,MAAM;AAAA,UACZ,CAAM;AACDA,wBAAA,MAAA,MAAA,SAAA,4CAAc,KAAK,UAAU,GAAG,CAAC;AACjC,mBAAS,KAAK;AAOd,cAAI,IAAI,UAAU,8BAA8B;AAC/CA,0BAAAA,MAAI,UAAU;AAAA,cACb,SAAS;AAAA,cACT,aAAa;AAAA,cACb,UAAU,CAAC,MAAM;AAChB,oBAAI,EAAE,SAAS;AACdA,gCAAAA,MAAI,YAAY;AAAA,oBACf,QAAQ,KAAK;AACZA,oCAAAA,MAAA,MAAA,OAAA,4CAAY,IAAI,WAAW;AAAA,oBAC3B;AAAA,kBACX,CAAU;AAAA,gBACD;AACD,qBAAK,OAAO;AAAA,cACZ;AAAA,YACR,CAAO;AAAA,UACD;AACD,cAAI,IAAI,UAAU,wDAAwD;AACzEA,0BAAAA,MAAI,UAAU;AAAA,cACb,SAAS;AAAA,cACT,YAAY;AAAA,cACZ,aAAY;AAAA,YACnB,CAAO;AAAA,UACD;AAAA,QAED;AAAA,MACL,CAAI;AAAA,IACJ,CAAG;AAAA,EACD;AAkEF;;"}