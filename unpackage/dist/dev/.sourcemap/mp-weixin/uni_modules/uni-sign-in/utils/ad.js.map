{"version":3,"file":"ad.js","sources":["uni_modules/uni-sign-in/utils/ad.js"],"sourcesContent":["// ad.js\r\nconst ADType = {\r\n  RewardedVideo: \"RewardedVideo\",\r\n  FullScreenVideo: \"FullScreenVideo\"\r\n}\r\n\r\nclass AdHelper {\r\n\r\n  constructor() {\r\n    this._ads = {}\r\n  }\r\n\r\n  load(options, onload, onerror) {\r\n    let ops = this._fixOldOptions(options)\r\n    let {\r\n      adpid\r\n    } = ops\r\n\r\n    if (!adpid || this.isBusy(adpid)) {\r\n      return\r\n    }\r\n\r\n    this.get(ops).load(onload, onerror)\r\n  }\r\n\r\n  show(options, onsuccess, onfail) {\r\n    let ops = this._fixOldOptions(options)\r\n    let {\r\n      adpid\r\n    } = ops\r\n\r\n    if (!adpid) {\r\n      return\r\n    }\r\n\r\n    uni.showLoading({\r\n      mask: true\r\n    })\r\n\r\n    var ad = this.get(ops)\r\n\r\n    ad.load(() => {\r\n      uni.hideLoading()\r\n      ad.show((e) => {\r\n        onsuccess && onsuccess(e)\r\n      })\r\n    }, (err) => {\r\n      uni.hideLoading()\r\n      onfail && onfail(err)\r\n    })\r\n  }\r\n\r\n  isBusy(adpid) {\r\n    return (this._ads[adpid] && this._ads[adpid].isLoading)\r\n  }\r\n\r\n  get(options) {\r\n    const {\r\n      adpid,\r\n      singleton = true\r\n    } = options\r\n    if (singleton === false) {\r\n      if (this._ads[adpid]) {\r\n        this._ads[adpid].destroy()\r\n        delete this._ads[adpid]\r\n      }\r\n    }\r\n    delete options.singleton\r\n    if (!this._ads[adpid]) {\r\n      this._ads[adpid] = this._createAdInstance(options)\r\n    }\r\n\r\n    return this._ads[adpid]\r\n  }\r\n\r\n  _createAdInstance(options) {\r\n    const adType = options.adType || ADType.RewardedVideo\r\n    delete options.adType\r\n\r\n    let ad = null;\r\n    if (adType === ADType.RewardedVideo) {\r\n      ad = new RewardedVideo(options)\r\n    } else if (adType === ADType.FullScreenVideo) {\r\n      ad = new FullScreenVideo(options)\r\n    }\r\n\r\n    return ad\r\n  }\r\n\r\n  _fixOldOptions(options) {\r\n    return (typeof options === \"string\") ? {\r\n      adpid: options\r\n    } : options\r\n  }\r\n}\r\n\r\nconst EXPIRED_TIME = 1000 * 60 * 30\r\nconst ProviderType = {\r\n  CSJ: 'csj',\r\n  GDT: 'gdt'\r\n}\r\n\r\nconst RETRY_COUNT = 1\r\n\r\nclass AdBase {\r\n  constructor(adInstance, options = {}) {\r\n    this._isLoad = false\r\n    this._isLoading = false\r\n    this._lastLoadTime = 0\r\n    this._lastError = null\r\n    this._retryCount = 0\r\n\r\n    this._loadCallback = null\r\n    this._closeCallback = null\r\n    this._errorCallback = null\r\n\r\n    const ad = this._ad = adInstance\r\n    ad.onLoad((e) => {\r\n      this._isLoading = false\r\n      this._isLoad = true\r\n      this._lastLoadTime = Date.now()\r\n\r\n      this.onLoad()\r\n    })\r\n    ad.onClose((e) => {\r\n      this._isLoad = false\r\n      this.onClose(e)\r\n    })\r\n    ad.onVerify && ad.onVerify((e) => {\r\n      // e.isValid\r\n    })\r\n    ad.onError(({\r\n      code,\r\n      message\r\n    }) => {\r\n      this._isLoading = false\r\n      const data = {\r\n        code: code,\r\n        errMsg: message\r\n      }\r\n\r\n      if (code === -5008) {\r\n        this._loadAd()\r\n        return\r\n      }\r\n\r\n      if (this._retryCount < RETRY_COUNT) {\r\n        this._retryCount += 1\r\n        this._loadAd()\r\n        return\r\n      }\r\n\r\n      this._lastError = data\r\n      this.onError(data)\r\n    })\r\n  }\r\n\r\n  get isExpired() {\r\n    return (this._lastLoadTime !== 0 && (Math.abs(Date.now() - this._lastLoadTime) > EXPIRED_TIME))\r\n  }\r\n\r\n  get isLoading() {\r\n    return this._isLoading\r\n  }\r\n\r\n  getProvider() {\r\n    return this._ad.getProvider()\r\n  }\r\n\r\n  load(onload, onerror) {\r\n    this._loadCallback = onload\r\n    this._errorCallback = onerror\r\n\r\n    if (this._isLoading) {\r\n      return\r\n    }\r\n\r\n    if (this._isLoad) {\r\n      this.onLoad()\r\n      return\r\n    }\r\n\r\n    this._retryCount = 0\r\n\r\n    this._loadAd()\r\n  }\r\n\r\n  show(onclose) {\r\n    this._closeCallback = onclose\r\n\r\n    if (this._isLoading || !this._isLoad) {\r\n      return\r\n    }\r\n\r\n    if (this._lastError !== null) {\r\n      this.onError(this._lastError)\r\n      return\r\n    }\r\n\r\n    const provider = this.getProvider()\r\n    if (provider === ProviderType.CSJ && this.isExpired) {\r\n      this._loadAd()\r\n      return\r\n    }\r\n\r\n    this._ad.show()\r\n  }\r\n\r\n  onLoad(e) {\r\n    if (this._loadCallback != null) {\r\n      this._loadCallback()\r\n    }\r\n  }\r\n\r\n  onClose(e) {\r\n    if (this._closeCallback != null) {\r\n      this._closeCallback({\r\n        isEnded: e.isEnded\r\n      })\r\n    }\r\n  }\r\n\r\n  onError(e) {\r\n    if (this._errorCallback != null) {\r\n      this._errorCallback(e)\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this._ad.destroy()\r\n  }\r\n\r\n  _loadAd() {\r\n    this._isLoad = false\r\n    this._isLoading = true\r\n    this._lastError = null\r\n    this._ad.load()\r\n  }\r\n}\r\n\r\nclass RewardedVideo extends AdBase {\r\n  constructor(options = {}) {\r\n    super(plus.ad.createRewardedVideoAd(options), options)\r\n  }\r\n}\r\n\r\nclass FullScreenVideo extends AdBase {\r\n  constructor(options = {}) {\r\n    super(plus.ad.createFullScreenVideoAd(options), options)\r\n  }\r\n}\r\n\r\nexport default new AdHelper()"],"names":["uni"],"mappings":"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"}